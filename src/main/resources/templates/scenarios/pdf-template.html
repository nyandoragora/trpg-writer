<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${scenario.title}"></title>
    <link rel="stylesheet" type="text/css" href="css/pdf-style.css" />
</head>
<body>
    <h1 class="scenario-title" th:text="${scenario.title}"></h1>
    <p class="scenario-description" th:text="${scenario.introduction}"></p>

    <div th:each="scene : ${scenes}" class="scene">
        <h2 class="scene-title" th:id="'scene-' + ${scene.id}" th:text="${scene.title}"></h2>

        <!-- GM Info Section -->
        <div th:if="${scene.gmInfo != null and !scene.gmInfo.isEmpty()}" class="gm-info">
            <h4>GM向け情報</h4>
            <p th:text="${scene.gmInfo}"></p>
        </div>

        <div class="scene-content" th:utext="${scene.content}"></div>

        <!-- Scene NPC Summary -->
        <div th:if="${sceneNpcCountMap.containsKey(scene.id)}" class="scene-npc-summary">
            <h4>登場NPC</h4>
            <ul>
                <li th:each="entry : ${sceneNpcCountMap.get(scene.id)}">
                    <a th:href="'#npc-' + ${entry.key.id}" th:text="${entry.key.name} + ' (Lv.' + ${entry.key.level} + ')'"></a>
                    <span th:if="${entry.value > 1}" th:text="' x' + ${entry.value}"></span>
                </li>
            </ul>
        </div>

        <!-- Scene Infos Section -->
        <div th:if="${sceneInfosMap.containsKey(scene.id) and !sceneInfosMap.get(scene.id).isEmpty()}" class="scene-info-section">
            <h4>シーン内情報</h4>
            <div th:each="info : ${sceneInfosMap.get(scene.id)}" class="info-card">
                <h5 class="info-title">
                    <a th:href="'#info-' + ${info.id}" th:text="${info.name}"></a>
                </h5>
                <p class="info-content" th:text="${info.content}"></p>
            </div>
        </div>
    </div>

    <!-- Info Summary Page -->
    <div th:if="${infoToScenesMap != null and !infoToScenesMap.isEmpty()}" class="info-summary-page">
        <h2 class="summary-title">情報一覧</h2>
        <div th:each="entry : ${infoToScenesMap}" class="summary-item">
            <h4 class="summary-info-title" th:id="'info-' + ${entry.key.id}" th:text="${entry.key.name}"></h4>
            <p class="summary-info-content" th:text="${entry.key.content}"></p>
            <p class="summary-scene-ref">
                （登場シーン： 
                <span th:each="scene, iterStat : ${entry.value}">
                    <a th:href="'#scene-' + ${scene.id}" th:text="${scene.title}"></a>
                    <span th:if="!${iterStat.last}">, </span>
                </span>
                ）
            </p>
        </div>
    </div>

    <!-- Handout Page -->
    <div th:if="${infoToScenesMap != null and !infoToScenesMap.isEmpty()}" class="handout-page">
        <h2 class="summary-title">配布資料</h2>
        <div class="handout-container">
            <div th:each="entry : ${infoToScenesMap}" class="handout-card">
                <div class="handout-header" th:text="${entry.key.name}"></div>
                <div class="handout-body" th:text="${entry.key.content}"></div>
            </div>
        </div>
    </div>

    <!-- NPC Summary Page -->
    <div th:if="${allNpcs != null and !allNpcs.isEmpty()}" class="npc-summary-page">
        <h2 class="summary-title">登場NPC一覧</h2>
        <div th:each="npc : ${allNpcs}" class="npc-data-sheet">
            <h3 class="npc-name" th:id="'npc-' + ${npc.id}" th:text="${npc.name} + ' (Lv.' + ${npc.level} + ')'"></h3>
            <div class="npc-details">
                <p class="summary-scene-ref" th:if="${npcToScenesMap.containsKey(npc)}">
                    （登場シーン：
                    <span th:each="scene, iterStat : ${npcToScenesMap.get(npc)}">
                        <a th:href="'#scene-' + ${scene.id}" th:text="${scene.title}"></a>
                        <span th:if="!${iterStat.last}">, </span>
                    </span>
                    ）
                </p>
                <p th:if="${npc.description != null and !npc.description.isEmpty()}" th:text="${npc.description}"></p>
                <table class="status-table">
                    <tr>
                        <th>知能</th><td th:text="${npc.intelligence}"></td>
                        <th>穢れ</th><td th:text="${npc.impurity}"></td>
                        <th>生命抵抗</th><td th:text="${npc.lifeResist}"></td>
                    </tr>
                    <tr>
                        <th>知覚</th><td th:text="${npc.perception}"></td>
                        <th>言語</th><td th:text="${npc.language}"></td>
                        <th>精神抵抗</th><td th:text="${npc.mindResist}"></td>
                    </tr>
                     <tr>
                        <th>反応</th><td th:text="${npc.position}"></td>
                        <th>生息地</th><td th:text="${npc.habitat}"></td>
                        <th>先制値</th><td th:text="${npc.preemptive}"></td>
                    </tr>
                     <tr>
                        <th>知名度</th><td th:text="${npc.popularity}"></td>
                        <th>弱点</th><td th:text="${npc.weakness}"></td>
                        <th>移動速度</th><td th:text="${npc.movement}"></td>
                    </tr>
                </table>

                <div th:if="${npc.parts != null and !npc.parts.isEmpty()}">
                    <h4>部位</h4>
                    <ul class="part-list">
                        <li th:each="part : ${npc.parts}" th:text="${part.part.name} + ' (命中力:' + ${part.part.hit} + ', ダメージ:' + ${part.part.damage} + ', HP:' + ${part.part.lifePoint} + ', MP:' + ${part.part.magicPoint} + ', 防護点:' + ${part.part.protection} + ', 回避力:' + ${part.part.evasion} + ')'"></li>
                    </ul>
                </div>

                <div th:if="${npc.skills != null and !npc.skills.isEmpty()}">
                    <h4>特殊能力</h4>
                    <ul class="skill-list">
                        <li th:each="skill : ${npc.skills}" th:text="${skill.skill.name} + ': ' + ${skill.skill.content}"></li>
                    </ul>
                </div>

                <div th:if="${npc.bootys != null and !npc.bootys.isEmpty()}">
                    <h4>戦利品</h4>
                    <ul class="booty-list">
                        <li th:each="booty : ${npc.bootys}" th:text="${booty.booty.content} + ' (' + ${booty.booty.diceNum} + ')'"></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
